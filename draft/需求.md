# 需求

> 目标想要给予reth做一个dex，保留EVM的全部功能，当然Dex的逻辑会在自定义的VM里
> 尽可能复用Reth组件，而不是自己开发
> 为了可行性和了解reth模块化程度，Dex逻辑先不写，简单维护一个计数器状态机即可
> 多打印一些日志，看看两个VM是如何并存的

---

## 需求列表及完成状态

| 需求 | 状态 | 完成度 | 备注 |
|------|------|--------|------|
| EVM图灵完备功能 | ✅ 完成 | 95% | revm 27 执行器完整实现 |
| CustomVM (CounterVM) | ✅ 完成 | 95% | 计数器VM完整实现 |
| P2P机制 | ⚠️ 进行中 | 70% | 基础框架完整 |
| POA共识机制 | ✅ 完成 | 95% | 单验证者出块 |
| 测试脚本 | ✅ 完成 | 90% | 单元测试完成，集成测试脚本已创建 |
| 创世文件支持 | ✅ 完成 | 100% | JSON格式支持，示例文件已创建 |
| 数据持久化 | ✅ 完成 | 85% | MDBX数据库 |
| 最终集成测试 | ⚠️ 进行中 | 60% | 测试脚本已创建，待运行验证 |

---

## 一、核心功能需求

### 1.1 EVM的图灵完备功能
- 能够执行智能合约，EVM能够执行
- **实现方案**：基于 `revm` 库实现 EVM 执行器
- **当前状态**：✅ revm 27 执行器完整实现
  - `ExecutionResult`、`Output` 从 `revm::context::result` 导入
  - `PrecompileErrors` 改为 `PrecompileError`
  - `DBErrorMarker` trait 已实现自定义错误类型
  - Inspector trait 已适配新 API（移除 sload/sstore）
  - 完整的 EVM 执行流程：Context → MainnetEvm → transact_commit
  - 支持 execute_transaction（写入状态）和 execute_call（只读调用）
  - 支持 gas estimation（gas 估算）

### 1.2 CustomVM，CounterVM
- 为了验证双VM的方案，这个VM简单实现即可，即每个账户可以维护一个计数器
- **实现模块**：`crates/dexvm/`
- **当前状态**：✅ 完成
- **功能特性**：
  - 操作类型：Increment（增加）、Decrement（减少）、Query（查询）
  - Gas 成本：BASE=21000, INC/DEC=5000, QUERY=3000
  - 状态管理：Pending/Committed 双状态
  - 预编译合约：存款/取款功能（地址：`0x0000...0100`）

### 1.3 P2P机制
- 能够节点发现，当然测试阶段可以使用点对点直连
- **实现模块**：`crates/p2p/`
- **当前状态**：⚠️ 基础框架完整，消息处理待完善
- **功能特性**：
  - 基于 reth-network-peers，支持 devp2p 协议
  - PeerManager 管理对等体生命周期
  - 异步事件系统 (Tokio broadcast channel)
  - **待实现**：eth 协议消息处理、ENR/DNS 节点发现

### 1.4 POA共识机制
- 需要能够指定验证者，节点在运行时，如果是validator，需要指定validator的私钥
- 系统在创世文件里面指定一个验证者，为出块节点
- 全节点不能出块，只能同步，是个只读节点
- **实现模块**：`crates/node/src/consensus.rs`
- **当前状态**：✅ 完成
- **功能特性**：
  - `PoaConfig`：验证者地址、区块间隔配置
  - `BlockProposal`：区块提议结构
  - `PoaConsensus`：时间驱动的区块生成

---

## 二、架构设计

### 2.1 项目结构

```
crates/
├── primitives/     # 核心类型 (DualVmTransaction, DexVmReceipt)
├── dexvm/          # DexVM实现 (state.rs, executor.rs, precompiles.rs)
├── evm/            # EVM执行器 (基于revm) [需修复]
├── storage/        # MDBX数据库表和存储
├── rpc/            # REST API (Axum) + JSON-RPC (jsonrpsee)
├── p2p/            # P2P网络 (eth devp2p协议)
└── node/           # 节点集成 (DualVmNode, POA共识)

bin/dex-reth/
└── main.rs         # CLI入口
```

### 2.2 交易路由机制

```
交易到达 → 检查 to 地址
  ├─ 0xddddddddddddddddddddddddddddddddddddddd1 → DexVM (特殊地址)
  └─ 其他地址 → EVM
```

### 2.3 状态根计算

```
EVM状态根 (keccak256(sorted_account_data))
                ↓
         keccak256(evm_root || dexvm_root)
                ↑
DexVM状态根 (keccak256(sorted_counter_data))
```

### 2.4 网络端口

| 端口 | 服务 | 协议 |
|------|------|------|
| 8545 | EVM RPC | JSON-RPC |
| 9845 | DexVM API | REST |
| 30303 | P2P | devp2p |

---

## 三、DexVM Calldata 格式

```
[op_type: u8][amount: u64 big-endian]
```
- `0` = Increment（增加计数器）
- `1` = Decrement（减少计数器）
- `2` = Query（查询计数器）

### 预编译合约

存款/取款预编译地址：`0x0000000000000000000000000000000000000100`
- 发送 ETH 且 calldata 为空 = Deposit（存款）
- 发送带有 amount 的 calldata = Withdraw（取款）
- 空调用 = Query（查询余额）

---

## 四、创世文件格式

### 4.1 示例创世文件 (genesis.json)

```json
{
  "config": {
    "chainId": 13337
  },
  "timestamp": "0x0",
  "gasLimit": "0x1c9c380",
  "difficulty": "0x1",
  "alloc": {
    "0x1111111111111111111111111111111111111111": {
      "balance": "1000000000000000000000"
    },
    "0x2222222222222222222222222222222222222222": {
      "balance": "1000000000000000000000"
    },
    "0x3333333333333333333333333333333333333333": {
      "balance": "1000000000000000000000"
    },
    "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266": {
      "balance": "10000000000000000000000"
    }
  },
  "coinbase": "0x0000000000000000000000000000000000000000",
  "extraData": "0x"
}
```

### 4.2 测试账户私钥

| 地址 | 私钥 | 用途 |
|------|------|------|
| 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 | 0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80 | 验证者/测试账户 |
| 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 | 0x59c6995e998f97a5a0044966f0945389dc9e86dae88c7a8412f4603b6b78690d | 测试账户2 |
| 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC | 0x5de4111afa1a4b94908f83103eb1f1706367c2e68ca870fc3fb9a804cdab365a | 测试账户3 |

> 注：以上为 Hardhat 默认测试账户，仅供开发测试使用

---

## 五、启动命令

### 5.1 验证者节点启动

```bash
cargo run --release --bin dex-reth -- \
    --datadir ./data/validator \
    --genesis genesis.json \
    --enable-consensus \
    --validator 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 \
    --block-interval-ms 500 \
    --evm-rpc-port 8545 \
    --dexvm-port 9845
```

### 5.2 全节点启动（只读）

```bash
cargo run --release --bin dex-reth -- \
    --datadir ./data/fullnode \
    --genesis genesis.json \
    --evm-rpc-port 8546 \
    --dexvm-port 9846 \
    --enable-p2p \
    --p2p-port 30304
```

### 5.3 带 P2P 的验证者节点

```bash
cargo run --release --bin dex-reth -- \
    --datadir ./data/validator \
    --genesis genesis.json \
    --enable-consensus \
    --enable-p2p \
    --validator 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266 \
    --block-interval-ms 500 \
    --p2p-port 30303 \
    --max-peers 50
```

---

## 六、API 接口

### 6.1 DexVM REST API

```bash
# 健康检查
GET http://localhost:9845/health

# 查询计数器
GET http://localhost:9845/api/v1/counter/:address

# 增加计数器
POST http://localhost:9845/api/v1/counter/:address/increment
Content-Type: application/json
{"amount": 10}

# 减少计数器
POST http://localhost:9845/api/v1/counter/:address/decrement
Content-Type: application/json
{"amount": 5}

# 获取状态根
GET http://localhost:9845/api/v1/state-root
```

### 6.2 EVM JSON-RPC

```bash
# 获取链 ID
curl -X POST http://localhost:8545 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_chainId","params":[],"id":1}'

# 获取区块高度
curl -X POST http://localhost:8545 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_blockNumber","params":[],"id":1}'

# 获取余额
curl -X POST http://localhost:8545 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_getBalance","params":["0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266","latest"],"id":1}'

# 发送原始交易
curl -X POST http://localhost:8545 \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"eth_sendRawTransaction","params":["0x..."],"id":1}'
```

---

## 七、测试方案

### 7.1 单元测试

```bash
# 运行所有测试
cargo test

# 运行特定 crate 的测试
cargo test -p dex-primitives
cargo test -p dex-dexvm
cargo test -p dex-storage
cargo test -p dex-node
```

### 7.2 集成测试脚本

#### 测试 1：DexVM 计数器操作

```bash
#!/bin/bash
# test_counter.sh

ADDR="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"
BASE_URL="http://localhost:9845"

echo "=== 测试 DexVM 计数器 ==="

# 查询初始值
echo "1. 查询初始计数器值..."
curl -s "$BASE_URL/api/v1/counter/$ADDR" | jq .

# 增加计数器
echo "2. 增加计数器 +10..."
curl -s -X POST "$BASE_URL/api/v1/counter/$ADDR/increment" \
  -H "Content-Type: application/json" \
  -d '{"amount": 10}' | jq .

# 查询更新后的值
echo "3. 查询更新后的计数器值..."
curl -s "$BASE_URL/api/v1/counter/$ADDR" | jq .

# 减少计数器
echo "4. 减少计数器 -3..."
curl -s -X POST "$BASE_URL/api/v1/counter/$ADDR/decrement" \
  -H "Content-Type: application/json" \
  -d '{"amount": 3}' | jq .

# 最终查询
echo "5. 查询最终计数器值..."
curl -s "$BASE_URL/api/v1/counter/$ADDR" | jq .

# 查询状态根
echo "6. 查询 DexVM 状态根..."
curl -s "$BASE_URL/api/v1/state-root" | jq .

echo "=== 测试完成 ==="
```

#### 测试 2：EVM 智能合约部署（存钱罐）

```solidity
// contracts/PiggyBank.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract PiggyBank {
    mapping(address => uint256) public balances;

    event Deposit(address indexed user, uint256 amount);
    event Withdraw(address indexed user, uint256 amount);

    function deposit() public payable {
        balances[msg.sender] += msg.value;
        emit Deposit(msg.sender, msg.value);
    }

    function withdraw(uint256 amount) public {
        require(balances[msg.sender] >= amount, "Insufficient balance");
        balances[msg.sender] -= amount;
        payable(msg.sender).transfer(amount);
        emit Withdraw(msg.sender, amount);
    }

    function getBalance(address user) public view returns (uint256) {
        return balances[user];
    }
}
```

#### 测试 3：使用 cast 进行 EVM 交易测试

```bash
#!/bin/bash
# test_evm.sh

RPC_URL="http://localhost:8545"
PRIVATE_KEY="0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
ADDR="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266"

echo "=== 测试 EVM 功能 ==="

# 查询链 ID
echo "1. 查询链 ID..."
cast chain-id --rpc-url $RPC_URL

# 查询区块高度
echo "2. 查询区块高度..."
cast block-number --rpc-url $RPC_URL

# 查询余额
echo "3. 查询账户余额..."
cast balance $ADDR --rpc-url $RPC_URL

# 发送 ETH 转账
echo "4. 发送 ETH 转账..."
cast send --private-key $PRIVATE_KEY \
  --rpc-url $RPC_URL \
  0x2222222222222222222222222222222222222222 \
  --value 1ether

echo "=== 测试完成 ==="
```

### 7.3 测试用例清单

| 测试项 | 描述 | 状态 |
|--------|------|------|
| DexVM 计数器增加 | 验证 Increment 操作 | ✅ 单元测试通过 |
| DexVM 计数器减少 | 验证 Decrement 操作 | ✅ 单元测试通过 |
| DexVM 计数器查询 | 验证 Query 操作 | ✅ 单元测试通过 |
| DexVM 状态回滚 | 验证 rollback 功能 | ✅ 单元测试通过 |
| DexVM 预编译存款 | 验证存款功能 | ✅ 单元测试通过 |
| DexVM 预编译取款 | 验证取款功能 | ✅ 单元测试通过 |
| 交易路由 - DexVM | 验证路由到 DexVM | ✅ 单元测试通过 |
| 交易路由 - EVM | 验证路由到 EVM | ✅ 单元测试通过 |
| MDBX 数据持久化 | 验证数据落盘 | ✅ 单元测试通过 |
| POA 区块生成 | 验证区块生成 | ✅ 单元测试通过 |
| EVM 合约部署 | 验证合约部署 | ⏳ 待 EVM 修复 |
| EVM 合约调用 | 验证合约执行 | ⏳ 待 EVM 修复 |
| P2P 节点连接 | 验证节点通信 | ⏳ 待完善 |
| 端到端集成测试 | 完整流程测试 | ❌ 未开始 |

---

## 八、数据库设计

### 8.1 MDBX 表结构

| 表名 | 键类型 | 值类型 | 用途 |
|------|--------|--------|------|
| DualvmBlocks | u64 | BlockHeader | 区块头存储 |
| DualvmAccounts | Address | AccountInfo | EVM 账户状态 |
| DualvmCounters | Address | u64 | DexVM 计数器状态 |
| DualvmStorage | (Address, U256) | U256 | 合约存储 |
| DualvmTxHashes | TxHash | (BlockNum, TxIndex) | 交易索引 |

### 8.2 数据目录结构

```
data/
├── mdbx.dat        # MDBX 主数据文件
├── mdbx.lck        # MDBX 锁文件
└── logs/           # 日志目录
```

---

## 九、待完成事项

### 已完成

1. ~~**修复 revm 版本兼容问题**~~ ✅
   - revm 27 API 已完成适配
   - 所有编译错误已修复
   - 单元测试全部通过

### 高优先级

2. **完善 EVM 执行器集成**
   - 基础框架已完成
   - 需要完善完整交易执行流程
   - 需要集成到节点主循环

3. **端到端集成测试**
   - 测试脚本已创建
   - 需要实际运行验证
   - 验证双 VM 协调

### 中优先级

4. **P2P 消息处理完整化**
   - 实现 eth 协议消息
   - 区块和交易同步

5. ~~**完善创世文件**~~ ✅
   - genesis.json 示例已创建
   - 测试账户已配置

### 低优先级

6. **性能优化**
   - 数据库查询缓存
   - 状态根计算优化

7. **文档和日志**
   - 完善错误处理
   - 增加调试日志

---

## 十、依赖版本

```toml
# 关键依赖
reth = "v1.5.1"
revm = "27.x"  # 需要版本适配
alloy = "1.x"
tokio = "1.x"
axum = "0.7"
jsonrpsee = "0.24"
```

---

## 十一、参考资料

- [reth 官方文档](https://paradigmxyz.github.io/reth/)
- [revm 文档](https://github.com/bluealloy/revm)
- [Ethereum JSON-RPC 规范](https://ethereum.org/developers/docs/apis/json-rpc)
- [devp2p 协议规范](https://github.com/ethereum/devp2p)